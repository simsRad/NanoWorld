import { initialize } from '@microsoft/power-apps/app';

export type SystemUser = {
  systemuserid: string;
  fullname?: string;
  domainname?: string;
  internalemailaddress?: string;
  title?: string;
  mobilephone?: string;
};

export class SystemUserService {
  private static instance: SystemUserService | null = null;
  private powerApps: any = null;
  private initialized = false;
  
  private constructor() {}

  public static getInstance(): SystemUserService {
    if (!SystemUserService.instance) {
      SystemUserService.instance = new SystemUserService();
    }
    return SystemUserService.instance;
  }

  private async init(): Promise<void> {
    if (this.initialized) return;

    try {
      this.powerApps = await initialize({ context: "default" });
      this.initialized = true;
    } catch (error) {
      console.error('Failed to initialize Power Apps:', error);
      throw error;
    }
  }

  public async getUsers(): Promise<SystemUser[]> {
    await this.init();
    try {
      const table = this.powerApps.data.createTable('systemuser');
      const result = await table.retrieveMultipleRecords({
        select: ['systemuserid', 'fullname', 'domainname', 'internalemailaddress', 'title', 'mobilephone']
      });
      return result.entities;
    } catch (error) {
      console.error('Failed to get users:', error);
      throw error;
    }
  }

  public async getCurrentUser(): Promise<SystemUser | null> {
    try {
      const users = await this.getUsers();
      return users[0] || null;
    } catch (error) {
      console.error('Failed to get current user:', error);
      throw error;
    }
  }
}

export default SystemUserService;
  private powerApps: PowerAppsApi | null = null;
  private connection: PowerAppsConnection | null = null;
  private initPromise: Promise<void> | null = null;

  private static instance: SystemUserService;

  private constructor() {}

  public static getInstance(): SystemUserService {
    if (!SystemUserService.instance) {
      SystemUserService.instance = new SystemUserService();
    }
    return SystemUserService.instance;
  }

  private async init(): Promise<void> {
    if (this.initPromise) return this.initPromise;

    this.initPromise = new Promise<void>(async (resolve, reject) => {
      try {
        console.log('Initializing Power Apps...');

        // Wait for document load
        if (document.readyState !== 'complete') {
          await new Promise<void>(r => window.addEventListener('load', () => r(), { once: true }));
        }

        // Allow time for environment setup
        await new Promise(r => setTimeout(r, 1000));

        this.powerApps = await initialize() as unknown as PowerAppsApi;
        
        if (!this.powerApps?.data) {
          throw new Error('Power Apps data API not available');
        }

        this.connection = await this.powerApps.data.getConnection({
          logicalName: 'shared_commondataserviceforapps'
        });

        console.log('Connected to Dataverse');
        resolve();
      } catch (error) {
        this.initPromise = null;
        reject(error);
      }
    });

    return this.initPromise;
  }

  public async getUsers(): Promise<SystemUser[]> {
    await this.init();
    
    if (!this.powerApps?.data || !this.connection) {
      throw new Error('Power Apps not properly initialized');
    }

    try {
      const table = this.powerApps.data.createTable('systemuser');
      const { entities } = await table.retrieveMultipleRecords({
        select: ['systemuserid', 'fullname', 'domainname', 'internalemailaddress', 'title', 'mobilephone']
      });

      return entities;
    } catch (error) {
      console.error('Error fetching users:', error);
      throw error;
    }
  }

  public async getCurrentUser(): Promise<SystemUser | null> {
    try {
      const users = await this.getUsers();
      const domain = window.location.hostname;
      return users.find(user => user.domainname?.toLowerCase().includes(domain)) || null;
    } catch (error) {
      console.error('Error fetching current user:', error);
      return null;
    }
  }
}
}

export default SystemUserService;
      this.powerApps = await initialize() as unknown as PowerAppsApi;
      
      if (!this.powerApps?.data) {
        throw new Error('Power Apps data API not available');
      }

      // Get connection
      this.connection = await this.powerApps.data.getConnection({
        logicalName: CONNECTION_NAME
      });

      console.log('Connected to Dataverse');
    } catch (error) {
      console.error('Failed to initialize Power Apps:', error);
      throw error;
    }
  };

  getUsers = async (): Promise<SystemUser[]> => {
    try {
      await powerAppsInitPromise;

      if (!this.powerApps?.data || !this.connection) {
        throw new Error('Power Apps not properly initialized');
      }

      const table = this.powerApps.data.createTable('systemuser');
      const { entities } = await table.retrieveMultipleRecords({
        select: ['systemuserid', 'fullname', 'domainname', 'internalemailaddress', 'title', 'mobilephone']
      });

      return entities;
    } catch (error) {
      console.error('Error fetching users:', error);
      throw error;
    }
  };

  getCurrentUser = async (): Promise<SystemUser | null> => {
    try {
      const users = await this.getUsers();
      const domain = window.location.hostname;
      return users.find(user => user.domainname?.toLowerCase().includes(domain)) || null;
    } catch (error) {
      console.error('Error fetching current user:', error);
      return null;
    }
  };
}

export default SystemUserService;

  constructor() {
    // Ensure initialization only happens once across all instances
    if (!powerAppsInitPromise) {
      powerAppsInitPromise = this.initializeApp();
    }
  }

  private async initializeApp(): Promise<void> {
    try {
      console.log('Initializing Power Apps...');

      // Wait for the window to fully load first
      if (document.readyState !== 'complete') {
        await new Promise(resolve => window.addEventListener('load', resolve, { once: true }));
      }

      // Initialize Power Apps
      this.powerApp = await initialize() as unknown as PowerAppsApi;
      
      console.log('Power Apps initialized');

      // Verify the data API is available
      if (!this.powerApp?.data) {
        throw new Error('Power Apps data API not available');
      }

      // Get the Dataverse connection with retry logic
      console.log('Getting Dataverse connection...');
      let retryCount = 0;
      const maxRetries = 3;
      let lastError: Error | null = null;
      
      while (retryCount < maxRetries) {
        try {
          this.connection = await this.powerApp.data.getConnection({ 
            logicalName: 'shared_commondataserviceforapps'
          });
          console.log('Successfully connected to Dataverse');
          return;
        } catch (error) {
          lastError = error as Error;
          retryCount++;
          if (retryCount < maxRetries) {
            await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
          }
        }
      }
      
      throw new Error(`Failed to connect to Dataverse after ${maxRetries} attempts: ${lastError?.message}`);
    } catch (error) {
      this.initializationError = error as Error;
      console.error('Failed to initialize Power Apps:', error);
      throw error;
    }
  }

  public async getUsers(): Promise<SystemUser[]> {
    try {
      // Ensure initialization is complete
      await powerAppsInitPromise;
      
      if (!this.powerApp || !this.connection) {
        throw new Error('Power Apps not properly initialized');
      }

      const systemUserTable = this.powerApp.data.createTable('systemuser');
      const result = await systemUserTable.retrieveMultipleRecords({
        select: ['systemuserid', 'fullname', 'domainname', 'internalemailaddress', 'title', 'mobilephone'],
      });

      return result.entities.map(user => ({
        systemuserid: user.systemuserid,
        fullname: user.fullname,
        domainname: user.domainname,
        internalemailaddress: user.internalemailaddress,
        title: user.title,
        mobilephone: user.mobilephone,
      }));
    } catch (error) {
      console.error('Error fetching users:', error);
      throw error;
    }
  }

  public async getCurrentUser(): Promise<SystemUser | null> {
    try {
      // Get all users and find the one matching current domain name
      const users = await this.getUsers();
      const currentDomain = window.location.hostname;
      
      return users.find(user => user.domainname?.toLowerCase().includes(currentDomain)) || null;
    } catch (error) {
      console.error('Error fetching current user:', error);
      return null;
    }
  }

      // Verify the data API is available
      if (!this.powerApp?.data) {
        throw new Error('Power Apps data API not available');
      }

      // Get the Dataverse connection with retry logic
      console.log('Getting Dataverse connection...');
      let retryCount = 0;
      const maxRetries = 3;
      
      while (retryCount < maxRetries) {
        try {
          this.connection = await this.powerApp.data.getConnection({ 
        logicalName: 'dataverse_connection' 
      });
      console.log('Dataverse connection established:', this.connection);

    } catch (error) {
      console.error('Failed to initialize Power Apps:', error);
      throw new Error('Failed to initialize Power Apps connection');
    }
  }

  async getUsers(): Promise<SystemUser[]> {
    try {
      if (!this.powerApp || !this.connection) {
        await this.initializeApp();
      }
      if (!this.powerApp?.data) {
        throw new Error('Power Apps data API not available');
      }

      console.log('Making request to Dataverse users...');

      const result = await this.powerApp.data.createTable('systemuser').retrieveMultipleRecords({
        select: ['systemuserid', 'fullname', 'domainname', 'internalemailaddress', 'title', 'mobilephone'],
        filter: 'isdisabled eq false'
      });

      console.log('Retrieved users:', result);
      return result.entities.map(user => ({
        systemuserid: user.systemuserid,
        fullname: user.fullname,
        domainname: user.domainname,
        internalemailaddress: user.internalemailaddress,
        title: user.title,
        mobilephone: user.mobilephone
      }));
    } catch (error) {
      console.error("Error fetching users:", error);
      throw new Error("Failed to fetch users from Dataverse");
    }
  }

  async getCurrentUser(): Promise<SystemUser> {
    try {
      if (!this.powerApp || !this.connection) {
        await this.initializeApp();
      }
      if (!this.powerApp?.data) {
        throw new Error('Power Apps data API not available');
      }

      // Using systemuser table to get current user
      const users = await this.powerApp.data.createTable('systemuser').retrieveMultipleRecords({
        select: ['systemuserid', 'fullname', 'domainname', 'internalemailaddress', 'title', 'mobilephone'],
        filter: 'isdisabled eq false'
      });

      if (!users.entities.length) {
        throw new Error('No users found');
      }

      // For now, return the first user as current user
      return users.entities[0];
    } catch (error) {
      console.error("Error fetching current user:", error);
      throw new Error("Failed to fetch current user from Dataverse");
    }
  }
}

export const systemUserService = new SystemUserService();
